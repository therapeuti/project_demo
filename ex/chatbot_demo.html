<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°˜ë ¤ë™ë¬¼ ì±—ë´‡</title>
    <style>
        /* ì±—ë´‡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .chatbot-trigger {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: move;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chatbot-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .chatbot-trigger svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* ì±—ë´‡ ì°½ ìŠ¤íƒ€ì¼ */
        .chatbot-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            z-index: 1001;
            overflow: hidden;
        }

        .chatbot-window.active {
            display: flex;
        }

        /* ì±—ë´‡ í—¤ë” */
        .chatbot-header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .chatbot-title {
            font-weight: bold;
            font-size: 16px;
        }

        .chatbot-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ë°˜ë ¤ë™ë¬¼ ì„ íƒ */
        .pet-selector {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .pet-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user {
            background: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .chat-input-area {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .chat-input:focus {
            border-color: #007bff;
        }

        .send-btn {
            background: #007bff;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #0056b3;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: #f1f3f4;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* íˆìŠ¤í† ë¦¬ ë²„íŠ¼ */
        .history-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #f5f5f5;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .chatbot-window {
                width: 300px;
                height: 450px;
                right: 20px;
                bottom: 90px;
            }
            
            .chatbot-trigger {
                right: 20px;
                bottom: 20px;
                width: 50px;
                height: 50px;
            }
        }

        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ */
        .dragging {
            transition: none !important;
            user-select: none;
        }

        /* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
        .history-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10;
        }

        .history-modal.active {
            display: flex;
            flex-direction: column;
        }

        .history-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        .history-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .history-preview {
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- ë©”ì¸ í˜ì´ì§€ ì»¨í…ì¸  (ë°ëª¨ìš©) -->
    <div style="padding: 20px; height: 200vh;">
        <h1>ë°˜ë ¤ë™ë¬¼ ì¼€ì–´ ì„œë¹„ìŠ¤</h1>
        <p>í˜ì´ì§€ë¥¼ ìŠ¤í¬ë¡¤í•˜ë©´ì„œ í•˜ë‹¨ì˜ ì±—ë´‡ ë²„íŠ¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>
        <p>ì±—ë´‡ ë²„íŠ¼ê³¼ ì°½ì€ ë“œë˜ê·¸í•˜ì—¬ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ì±—ë´‡ íŠ¸ë¦¬ê±° ë²„íŠ¼ -->
    <button class="chatbot-trigger" id="chatbotTrigger">
        <svg viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
    </button>

    <!-- ì±—ë´‡ ì°½ -->
    <div class="chatbot-window" id="chatbotWindow">
        <!-- í—¤ë” -->
        <div class="chatbot-header" id="chatbotHeader">
            <div class="chatbot-title" id="chatbotTitle">ë°˜ë ¤ë™ë¬¼ê³¼ ëŒ€í™”í•˜ê¸°</div>
            <div class="chatbot-controls">
                <button class="control-btn" id="historyBtn" title="ëŒ€í™” ê¸°ë¡">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3Z"/>
                    </svg>
                </button>
                <button class="control-btn" id="closeBtn" title="ë‹«ê¸°">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- ë°˜ë ¤ë™ë¬¼ ì„ íƒ -->
        <div class="pet-selector">
            <select class="pet-select" id="petSelect">
                <option value="">ë°˜ë ¤ë™ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div>ì•ˆë…•í•˜ì„¸ìš”! ë°˜ë ¤ë™ë¬¼ì„ ì„ íƒí•˜ê³  ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš” ğŸ¾</div>
                <div class="message-time">ì§€ê¸ˆ</div>
            </div>
        </div>

        <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
            <button class="send-btn" id="sendBtn" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                </svg>
            </button>
        </div>

        <!-- íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
        <div class="history-modal" id="historyModal">
            <div class="history-header">
                <h3>ëŒ€í™” ê¸°ë¡</h3>
                <button class="control-btn" id="closeHistoryBtn" style="color: #333;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                    </svg>
                </button>
            </div>
            <div class="history-list" id="historyList">
                <!-- íˆìŠ¤í† ë¦¬ ì•„ì´í…œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>
    </div>

    <script>
        class PetChatbot {
            constructor() {
                this.initElements();
                this.initEventListeners();
                this.loadPets();
                this.loadChatHistory();
                this.currentPetId = null;
                this.currentConversation = [];
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
            }

            initElements() {
                this.trigger = document.getElementById('chatbotTrigger');
                this.window = document.getElementById('chatbotWindow');
                this.header = document.getElementById('chatbotHeader');
                this.title = document.getElementById('chatbotTitle');
                this.closeBtn = document.getElementById('closeBtn');
                this.historyBtn = document.getElementById('historyBtn');
                this.petSelect = document.getElementById('petSelect');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.historyModal = document.getElementById('historyModal');
                this.historyList = document.getElementById('historyList');
                this.closeHistoryBtn = document.getElementById('closeHistoryBtn');
            }

            initEventListeners() {
                // ì±—ë´‡ íŠ¸ë¦¬ê±° ë²„íŠ¼
                this.trigger.addEventListener('click', () => this.toggleChatbot());
                
                // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (íŠ¸ë¦¬ê±° ë²„íŠ¼)
                this.trigger.addEventListener('mousedown', (e) => this.startDrag(e, this.trigger));
                
                // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ì±—ë´‡ í—¤ë”)
                this.header.addEventListener('mousedown', (e) => this.startDrag(e, this.window));
                
                // ê¸€ë¡œë²Œ ë“œë˜ê·¸ ì´ë²¤íŠ¸
                document.addEventListener('mousemove', (e) => this.onDrag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
                
                // ì±—ë´‡ ì»¨íŠ¸ë¡¤
                this.closeBtn.addEventListener('click', () => this.closeChatbot());
                this.historyBtn.addEventListener('click', () => this.showHistory());
                this.closeHistoryBtn.addEventListener('click', () => this.hideHistory());
                
                // ë°˜ë ¤ë™ë¬¼ ì„ íƒ
                this.petSelect.addEventListener('change', () => this.onPetChange());
                
                // ë©”ì‹œì§€ ì „ì†¡
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                // ì…ë ¥ í•„ë“œ í™œì„±í™”
                this.chatInput.addEventListener('input', () => {
                    this.sendBtn.disabled = !this.chatInput.value.trim();
                });
            }

            // ë“œë˜ê·¸ ê´€ë ¨ ë©”ì„œë“œ
            startDrag(e, element) {
                if (e.target.closest('.control-btn')) return;
                
                this.isDragging = true;
                this.dragTarget = element;
                
                const rect = element.getBoundingClientRect();
                this.dragOffset.x = e.clientX - rect.left;
                this.dragOffset.y = e.clientY - rect.top;
                
                element.classList.add('dragging');
                e.preventDefault();
            }

            onDrag(e) {
                if (!this.isDragging || !this.dragTarget) return;
                
                const x = e.clientX - this.dragOffset.x;
                const y = e.clientY - this.dragOffset.y;
                
                // í™”ë©´ ê²½ê³„ í™•ì¸
                const maxX = window.innerWidth - this.dragTarget.offsetWidth;
                const maxY = window.innerHeight - this.dragTarget.offsetHeight;
                
                const boundedX = Math.max(0, Math.min(maxX, x));
                const boundedY = Math.max(0, Math.min(maxY, y));
                
                this.dragTarget.style.left = boundedX + 'px';
                this.dragTarget.style.top = boundedY + 'px';
                this.dragTarget.style.right = 'auto';
                this.dragTarget.style.bottom = 'auto';
            }

            stopDrag() {
                if (this.isDragging && this.dragTarget) {
                    this.dragTarget.classList.remove('dragging');
                    this.isDragging = false;
                    this.dragTarget = null;
                }
            }

            // ì±—ë´‡ í‘œì‹œ/ìˆ¨ê¹€
            toggleChatbot() {
                if (this.isDragging) return;
                this.window.classList.toggle('active');
            }

            closeChatbot() {
                this.window.classList.remove('active');
            }

            // ë°˜ë ¤ë™ë¬¼ ë¡œë“œ
            async loadPets() {
                try {
                    // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” Flask API í˜¸ì¶œ
                    const response = await this.mockApiCall('/api/pets');
                    const pets = response.pets || [];
                    
                    this.petSelect.innerHTML = '<option value="">ë°˜ë ¤ë™ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    pets.forEach(pet => {
                        const option = document.createElement('option');
                        option.value = pet.id;
                        option.textContent = `${pet.name} (${pet.species})`;
                        option.dataset.persona = JSON.stringify(pet.persona);
                        this.petSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('ë°˜ë ¤ë™ë¬¼ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // ë°˜ë ¤ë™ë¬¼ ë³€ê²½ ì‹œ
            onPetChange() {
                const selectedOption = this.petSelect.selectedOptions[0];
                if (selectedOption && selectedOption.value) {
                    this.currentPetId = selectedOption.value;
                    const petName = selectedOption.textContent.split(' (')[0];
                    this.title.textContent = `${petName}ì™€ ëŒ€í™”í•˜ê¸°`;
                    
                    this.chatInput.disabled = false;
                    this.chatInput.placeholder = `${petName}ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì„¸ìš”...`;
                    
                    this.loadConversation(this.currentPetId);
                } else {
                    this.currentPetId = null;
                    this.title.textContent = 'ë°˜ë ¤ë™ë¬¼ê³¼ ëŒ€í™”í•˜ê¸°';
                    this.chatInput.disabled = true;
                    this.chatInput.placeholder = 'ë°˜ë ¤ë™ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”';
                    this.sendBtn.disabled = true;
                }
            }

            // ëŒ€í™” ë‚´ìš© ë¡œë“œ
            async loadConversation(petId) {
                try {
                    const response = await this.mockApiCall(`/api/chat/history/${petId}`);
                    this.currentConversation = response.messages || [];
                    this.renderMessages();
                } catch (error) {
                    console.error('ëŒ€í™” ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.currentConversation = [];
                    this.renderMessages();
                }
            }

            // ë©”ì‹œì§€ ë Œë”ë§
            renderMessages() {
                this.chatMessages.innerHTML = '';
                
                if (this.currentConversation.length === 0) {
                    const welcomeMsg = document.createElement('div');
                    welcomeMsg.className = 'message bot';
                    welcomeMsg.innerHTML = `
                        <div>ì•ˆë…•! ë‚˜ì™€ ëŒ€í™”í•´ë³´ì! ğŸ¾</div>
                        <div class="message-time">${this.formatTime(new Date())}</div>
                    `;
                    this.chatMessages.appendChild(welcomeMsg);
                } else {
                    this.currentConversation.forEach(msg => {
                        this.addMessageToChat(msg.content, msg.sender, new Date(msg.timestamp), false);
                    });
                }
                
                this.scrollToBottom();
            }

            // ë©”ì‹œì§€ ì „ì†¡
            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || !this.currentPetId) return;

                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                this.addMessageToChat(message, 'user', new Date());
                this.chatInput.value = '';
                this.sendBtn.disabled = true;

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
                this.showTypingIndicator();

                try {
                    // AI ì‘ë‹µ ìš”ì²­
                    const response = await this.sendToAI(message);
                    
                    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
                    this.hideTypingIndicator();
                    
                    // AI ì‘ë‹µ ì¶”ê°€
                    this.addMessageToChat(response.content, 'bot', new Date());
                    
                    // ëŒ€í™” ì €ì¥
                    await this.saveConversation();
                    
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessageToChat('ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ëŒ€ë‹µí•  ìˆ˜ ì—†ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot', new Date());
                    console.error('AI ì‘ë‹µ ì˜¤ë¥˜:', error);
                }
            }

            // AIì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
            async sendToAI(message) {
                const selectedOption = this.petSelect.selectedOptions[0];
                const persona = JSON.parse(selectedOption.dataset.persona || '{}');
                
                const requestData = {
                    message: message,
                    pet_id: this.currentPetId,
                    persona: persona,
                    conversation_history: this.currentConversation.slice(-10) // ìµœê·¼ 10ê°œ ë©”ì‹œì§€ë§Œ
                };

                return await this.mockApiCall('/api/chat/send', 'POST', requestData);
            }

            // ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
            addMessageToChat(content, sender, timestamp, save = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.innerHTML = `
                    <div>${content}</div>
                    <div class="message-time">${this.formatTime(timestamp)}</div>
                `;
                
                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì•ì— ì‚½ì…
                this.chatMessages.insertBefore(messageDiv, this.typingIndicator);
                
                if (save) {
                    this.currentConversation.push({
                        content: content,
                        sender: sender,
                        timestamp: timestamp.toISOString()
                    });
                }
                
                this.scrollToBottom();
            }

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            // ëŒ€í™” ì €ì¥
            async saveConversation() {
                try {
                    await this.mockApiCall('/api/chat/save', 'POST', {
                        pet_id: this.currentPetId,
                        messages: this.currentConversation
                    });
                } catch (error) {
                    console.error('ëŒ€í™” ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }

            // ëŒ€í™” ê¸°ë¡ í‘œì‹œ
            async showHistory() {
                try {
                    const response = await this.mockApiCall('/api/chat/sessions');
                    const sessions = response.sessions || [];
                    
                    this.historyList.innerHTML = '';
                    sessions.forEach(session => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `
                            <div class="history-date">${this.formatDate(new Date(session.last_message_time))}</div>
                            <div class="history-preview">${session.pet_name}: ${session.last_message}</div>
                        `;
                        item.addEventListener('click', () => this.loadHistorySession(session));
                        this.historyList.appendChild(item);
                    });
                    
                    this.historyModal.classList.add('active');
                } catch (error) {
                    console.error('ëŒ€í™” ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            hideHistory() {
                this.historyModal.classList.remove('active');
            }

            // íˆìŠ¤í† ë¦¬ ì„¸ì…˜ ë¡œë“œ
            async loadHistorySession(session) {
                this.petSelect.value = session.pet_id;
                this.onPetChange();
                this.hideHistory();
            }

            // ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ
            formatTime(date) {
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            formatDate(date) {
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }, 100);
            }

            // Mock API í˜¸ì¶œ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” fetch ì‚¬ìš©)
            async mockApiCall(url, method = 'GET', data = null) {
                // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©:
                /*
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: data ? JSON.stringify(data) : null
                });
                return await response.json();
                */
                
                // Mock ë°ì´í„°
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (url === '/api/pets') {
                            resolve({
                                pets: [
                                    {
                                        id: 1,
                                        name: 'ë©ë©ì´',
                                        species: 'ê°•ì•„ì§€',
                                        persona: {
                                            name: 'ë©ë©ì´',
                                            species: 'ê°•ì•„ì§€',
                                            personality: 'í™œë°œí•˜ê³  ì¹œê·¼í•¨',
                                            speaking_style: 'ê·€ì—½ê³  ì• êµìˆê²Œ',
                                            user_call: 'ì£¼ì¸ë‹˜',
                                            breed: 'ê³¨ë“  ë¦¬íŠ¸ë¦¬ë²„',
                                            likes: 'ì‚°ì±…, ê³µë†€ì´',
                                            dislikes: 'í° ì†Œë¦¬',
                                            etc: 'ê¼¬ë¦¬ë¥¼ ë§ì´ í”ë“¤ì–´ìš”'
                                        }
                                    },
                                    {
                                        id: 2,
                                        name: 'ì•¼ì˜¹ì´',
                                        species: 'ê³ ì–‘ì´',
                                        persona: {
                                            name: 'ì•¼ì˜¹ì´',
                                            species: 'ê³ ì–‘ì´',
                                            personality: 'ë„ë„í•˜ì§€ë§Œ ì• ì •ë§ìŒ',
                                            speaking_style: 'ì¸¤ë°ë ˆ',
                                            user_call: 'ì§‘ì‚¬',
                                            breed: 'ëŸ¬ì‹œì•ˆ ë¸”ë£¨',
                                            likes: 'í–‡ë³•ì¬ê¸°, ì°¸ì¹˜',
                                            dislikes: 'ë¬¼, ì‹œë„ëŸ¬ìš´ ì†Œë¦¬',
                                            etc: 'ìƒˆë²½ì— í™œë°œí•´ì ¸ìš”'
                                        }
                                    }
                                ]
                            });
                        } else if (url.startsWith('/api/chat/history/')) {
                            resolve({
                                messages: [
                                    {
                                        content: 'ì•ˆë…•! ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´?',
                                        sender: 'bot',
                                        timestamp: new Date(Date.now() - 3600000).toISOString()
                                    },
                                    {
                                        content: 'ì˜¤ëŠ˜ ì‚°ì±… ê°”ë‹¤ì™”ì–´!',
                                        sender: 'user',
                                        timestamp: new Date(Date.now() - 3500000).toISOString()
                                    }
                                ]
                            });
                        } else if (url === '/api/chat/send') {
                            // AI ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
                            const responses = [
                                'ì™€! ì •ë§ ì¢‹ì•˜ê² ë‹¤! ë‚˜ë„ ê°™ì´ ê°”ìœ¼ë©´ ì¢‹ì•˜ì„í…ë° ğŸ¾',
                                'ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•˜ì§€? ë°–ì— ë‚˜ê°€ë‹ˆê¹Œ ê¸°ë¶„ì´ ì–´ë•Œ?',
                                'ê·¸ë˜ê·¸ë˜! ë‚˜ë‘ ë†€ì•„ì¤˜ì„œ ê³ ë§ˆì›Œ! ğŸ¥°',
                                'ì£¼ì¸ë‹˜ì´ í–‰ë³µí•˜ë©´ ë‚˜ë„ í–‰ë³µí•´! íˆíˆ',
                                'ì˜¤ëŠ˜ë„ ìš°ë¦¬ í•¨ê»˜ ìˆì–´ì„œ ì¢‹ì•˜ì–´!'
                            ];
                            resolve({
                                content: responses[Math.floor(Math.random() * responses.length)]
                            });
                        } else if (url === '/api/chat/sessions') {
                            resolve({
                                sessions: [
                                    {
                                        pet_id: 1,
                                        pet_name: 'ë©ë©ì´',
                                        last_message: 'ì‚°ì±… ê°€ê³  ì‹¶ì–´!',
                                        last_message_time: new Date(Date.now() - 86400000).toISOString()
                                    },
                                    {
                                        pet_id: 2,
                                        pet_name: 'ì•¼ì˜¹ì´',
                                        last_message: 'ì°¸ì¹˜ ì£¼ì„¸ìš”...',
                                        last_message_time: new Date(Date.now() - 172800000).toISOString()
                                    }
                                ]
                            });
                        } else {
                            resolve({ success: true });
                        }
                    }, 1000);
                });
            }

            async loadChatHistory() {
                // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì„¤ì •
            }
        }

        // ì±—ë´‡ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new PetChatbot();
        });
    </script>
</body>
</html>